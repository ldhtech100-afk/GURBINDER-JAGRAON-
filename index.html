<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VLE Cards Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:20px; }
    .card { background:#fff; padding:16px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    h2 { margin:0 0 10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #ddd; text-align:left; }
    th { background:#eef3f8; }
    select { padding:6px; }
  </style>
</head>
<body>

<div class="card">
  <h2>Total Cards Issued</h2>
  <h1 id="totalCards">0</h1>
</div>

<div class="card">
  <h2>üèÜ Top 3 VLEs (All Dates)</h2>
  <table id="topVleTable">
    <tr><th>VLE Name</th><th>Total Cards</th></tr>
  </table>
</div>

<div class="card">
  <h2>üö´ VLEs Who Did Not Fill Form</h2>
  <label>Select Date: </label>
  <select id="dateSelect"></select>

  <table id="notFilledTable" style="margin-top:10px">
    <tr><th>VLE Name</th><th>Contact Number</th></tr>
  </table>
</div>

<script>
  google.charts.load('current', { packages:['table'] });
  google.charts.setOnLoadCallback(init);

  const SHEET_URL = "PASTE_YOUR_GOOGLE_SHEET_URL_HERE";
  const DATA_START_COL = 7; // Column H (26 Jan)

  let sheetData;

  function init() {
    const query = new google.visualization.Query(SHEET_URL);
    query.send(res => {
      sheetData = res.getDataTable();
      buildDateDropdown();
      calculateDashboard();
      document.getElementById("dateSelect").addEventListener("change", calculateDashboard);
    });
  }

  function buildDateDropdown() {
    const select = document.getElementById("dateSelect");
    select.innerHTML = "";

    for (let c = DATA_START_COL; c < sheetData.getNumberOfColumns(); c++) {
      const opt = document.createElement("option");
      opt.value = c;
      opt.text = sheetData.getColumnLabel(c);
      select.appendChild(opt);
    }

    // force default = first date (H)
    select.selectedIndex = 0;
  }

  function calculateDashboard() {
    let totalCards = 0;
    let vleTotals = [];
    let notFilled = [];

    const selectedDateCol = Number(document.getElementById("dateSelect").value);

    for (let r = 0; r < sheetData.getNumberOfRows(); r++) {
      const vleName = sheetData.getValue(r, 2); // VLE Name
      const vleContact = sheetData.getValue(r, 3);

      // ‚úÖ skip invalid / empty rows
      if (!vleName || vleName.toString().trim() === "") continue;

      let rowTotal = 0;

      // calculate totals (H onwards, include H)
      for (let c = DATA_START_COL; c < sheetData.getNumberOfColumns(); c++) {
        const val = sheetData.getValue(r, c);
        if (val !== null && val !== "" && !isNaN(val)) {
          rowTotal += Number(val);
          totalCards += Number(val);
        }
      }

      vleTotals.push([vleName, rowTotal]);

      // not-filled logic
      const dateCell = sheetData.getValue(r, selectedDateCol);
      const num = Number(dateCell);

      if (dateCell === null || dateCell === "" || isNaN(num)) {
        notFilled.push([vleName, vleContact]);
      }
    }

    // update total cards
    document.getElementById("totalCards").innerText = totalCards.toLocaleString();

    // Top 3 VLEs
    vleTotals.sort((a,b) => b[1] - a[1]);
    const topTable = document.getElementById("topVleTable");
    topTable.innerHTML = "<tr><th>VLE Name</th><th>Total Cards</th></tr>";

    vleTotals.slice(0,3).forEach(r => {
      topTable.innerHTML += `<tr><td>${r[0]}</td><td>${r[1].toLocaleString()}</td></tr>`;
    });

    // Not Filled table
    const nfTable = document.getElementById("notFilledTable");
    nfTable.innerHTML = "<tr><th>VLE Name</th><th>Contact Number</th></tr>";

    notFilled.forEach(r => {
      nfTable.innerHTML += `<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`;
    });
  }
</script>

</body>
</html>
