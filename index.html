<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VLE Card Issue Dashboard</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f7;
      padding: 20px;
    }
    .kpi, .section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      margin-bottom: 20px;
    }
  </style>

  <script>
    google.charts.load('current', { packages: ['table'] });
    google.charts.setOnLoadCallback(loadData);

    const SHEET_ID = "179_3BEpwPIt1kSFgQYb5SzdxkmNYVQpsyFNFN38_l-E";
    const GID = "1247592058";
    const DATA_START_COL = 7; // Column H

    let sheetData;

    function loadData() {
      const query = new google.visualization.Query(
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}`
      );
      query.send(res => {
        sheetData = res.getDataTable();
        buildDateDropdown();
        calculate();
      });
    }

    function buildDateDropdown() {
      const select = document.getElementById("dateSelect");
      select.innerHTML = "";

      for (let c = DATA_START_COL; c < sheetData.getNumberOfColumns(); c++) {
        const opt = document.createElement("option");
        opt.value = c;
        opt.text = sheetData.getColumnLabel(c);
        select.appendChild(opt);
      }

      select.selectedIndex = 0; // default = 26 Jan
    }

    function calculate() {
      const selectedDateCol = Number(document.getElementById("dateSelect").value);

      let totalCards = 0;
      let vleTotals = [];
      let notFilled = [];

      for (let r = 0; r < sheetData.getNumberOfRows(); r++) {

        const vleName = sheetData.getValue(r, 2);
        const vleContact = sheetData.getValue(r, 3);

        let rowTotal = 0;

        // ‚úÖ TOTAL & TOP-3 LOGIC
        for (let c = DATA_START_COL; c < sheetData.getNumberOfColumns(); c++) {
          const val = sheetData.getValue(r, c);
          if (val !== null && val !== "" && !isNaN(val)) {
            rowTotal += Number(val);
            totalCards += Number(val);
          }
        }

        vleTotals.push([vleName, rowTotal]);

        // ‚úÖ NOT FILLED LOGIC (FINAL & CORRECT)
        const dateCell = sheetData.getValue(r, selectedDateCol);
        if (dateCell === null || dateCell === "") {
          notFilled.push([vleName, vleContact]);
        }
      }

      document.getElementById("totalCards").innerText = totalCards;

      vleTotals.sort((a, b) => b[1] - a[1]);
      drawTable("top3", ["VLE Name", "Total Cards"], vleTotals.slice(0, 3));
      drawTable("notFilled", ["VLE Name", "Contact Number"], notFilled);
    }

    function drawTable(id, headers, rows) {
      const table = new google.visualization.Table(document.getElementById(id));
      table.draw(
        google.visualization.arrayToDataTable([headers, ...rows]),
        { width: "100%" }
      );
    }
  </script>
</head>

<body>

  <h1>üìä VLE Card Issue Dashboard</h1>

  <div class="kpi">
    <b>Total Cards Issued</b><br>
    <span id="totalCards">0</span>
  </div>

  <div class="section">
    <h3>üèÜ Top 3 VLEs (All Dates)</h3>
    <div id="top3"></div>
  </div>

  <div class="section">
    <h3>üö´ VLEs Who Did Not Fill Form</h3>
    Select Date:
    <select id="dateSelect" onchange="calculate()"></select>
    <div id="notFilled"></div>
  </div>

</body>
</html>
