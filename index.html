<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VLE Card Issue Dashboard</title>

  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f7;
      padding: 20px;
    }
    h1 {
      margin-bottom: 15px;
    }
    .kpi {
      background: #ffffff;
      padding: 20px;
      width: 320px;
      border-radius: 10px;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      margin-bottom: 25px;
    }
    .section {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    select {
      padding: 6px;
      margin-bottom: 10px;
    }
  </style>

  <script>
    google.charts.load('current', { packages: ['table'] });
    google.charts.setOnLoadCallback(loadData);

    // ================= CONFIG =================
    const SHEET_ID = "179_3BEpwPIt1kSFgQYb5SzdxkmNYVQpsyFNFN38_l-E";
    const GID = "1247592058";
    const DATA_START_COL = 7; // Column H (0-based)
    // ==========================================

    let sheetData = null;

    function loadData() {
      const query = new google.visualization.Query(
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}`
      );
      query.send(response => {
        sheetData = response.getDataTable();
        buildDateDropdown();
        calculateDashboard();
      });
    }

    function buildDateDropdown() {
      const select = document.getElementById("dateSelect");
      select.innerHTML = "";

      for (let c = DATA_START_COL; c < sheetData.getNumberOfColumns(); c++) {
        const option = document.createElement("option");
        option.value = c;
        option.text = sheetData.getColumnLabel(c);
        select.appendChild(option);
      }
    }

    function calculateDashboard() {
      const data = sheetData;
      const selectedDateCol = parseInt(document.getElementById("dateSelect").value);

      let totalCards = 0;
      let vleTotals = [];
      let notFilled = [];

      for (let r = 0; r < data.getNumberOfRows(); r++) {

        const vleName = data.getValue(r, 2);    // Column C
        const vleContact = data.getValue(r, 3); // Column D

        let rowTotal = 0;

        // ‚úÖ SUM ALL VALUES FROM COLUMN H ONWARDS
        for (let c = DATA_START_COL; c < data.getNumberOfColumns(); c++) {
          const val = data.getValue(r, c);
          if (val !== null && val !== "") {
            const num = Number(val);
            if (!isNaN(num)) {
              rowTotal += num;
              totalCards += num;
            }
          }
        }

        vleTotals.push([vleName, rowTotal]);

        // ‚úÖ NOT FILLED LOGIC (EMPTY OR NULL)
        const checkCell = data.getValue(r, selectedDateCol);
        if (checkCell === null || checkCell === "") {
          notFilled.push([vleName, vleContact]);
        }
      }

      document.getElementById("totalCards").innerText = totalCards;

      drawTop3(vleTotals);
      drawNotFilled(notFilled);
    }

    function drawTop3(vleTotals) {
      vleTotals.sort((a, b) => b[1] - a[1]);

      const tableData = google.visualization.arrayToDataTable([
        ["VLE Name", "Total Cards"],
        ...vleTotals.slice(0, 3)
      ]);

      const table = new google.visualization.Table(
        document.getElementById("top3Table")
      );
      table.draw(tableData, { width: "100%" });
    }

    function drawNotFilled(list) {
      const tableData = google.visualization.arrayToDataTable([
        ["VLE Name", "Contact Number"],
        ...list
      ]);

      const table = new google.visualization.Table(
        document.getElementById("notFilledTable")
      );
      table.draw(tableData, { width: "100%" });
    }
  </script>
</head>

<body>

  <h1>üìä VLE Card Issue Dashboard</h1>

  <div class="kpi">
    Total Cards Issued<br>
    <span id="totalCards">0</span>
  </div>

  <div class="section">
    <h3>üèÜ Top 3 VLEs (All Dates)</h3>
    <div id="top3Table"></div>
  </div>

  <div class="section">
    <h3>üö´ VLEs Who Did Not Fill Form</h3>
    <label>Select Date:</label><br>
    <select id="dateSelect" onchange="calculateDashboard()"></select>
    <div id="notFilledTable"></div>
  </div>

</body>
</html>
